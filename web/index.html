<html>
  <head>
    <title>Pink Fluffy Unicorn Game Engine</title>
    <link href="https://fonts.googleapis.com/css?family=Bubblegum+Sans" rel="stylesheet">
    <link rel='stylesheet' href='unicorn.css' />
    <script src="/web/pinkfluffyunicorn.min.js"></script>
    <script src="/web/maze.js"></script>
  </head>
  <body>
    <div id="unicorn-display"></div>
    <script>
      var counter = 0;
      const playerSpeed = 1;
      var players = {};
      // var player = {
      //   name,
      //   x,
      //   y,
      //   path,
      //   points
      // }
      // Removing doors
      maze = maze.map( x => x === 9 ? 0 : x );
      var pathBalls = [];
      function plotMap( x, y ) {
        Unicorn.AddObject( "b", {
          type: "circle",
          x: gridToMap( roomToGrid( x ) ), y: gridToMap( roomToGrid( y ) ),
          radius: 24,
          isStatic: true
        } );
      }
      function Init() {
        // Add Initialization Here
        PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
        Unicorn.Load( "map", "web/assets/floor.png" );
        var map = Unicorn.AddObject( "map", {
          type: "rectangle",
          x: Math.floor( 1920 / 2 ), y: Math.floor( 1080 / 2 ) - 9,
          width: 1920, height: 1080,
          sprite: "map",
          isStatic: true
        } );
        map.sprite.scale.x = 3;
        map.sprite.scale.y = 3;
        Unicorn.Load( "glow", "web/assets/lantern_glow.png" );
        var glows = [
          { x: 6, y: 5 },
          { x: 634, y: 5 },
          { x: 225, y: 35 },
          { x: 509, y: 29 },
          { x: 383, y: 58 },
          { x: 574, y: 63 },
          { x: 31, y: 95 },
          { x: 289, y: 95 },
          { x: 127, y: 128 },
          { x: 385, y: 126 },
          { x: 479, y: 128 },
          { x: 223, y: 159 },
          { x: 258, y: 223 },
          { x: 608, y: 223 },
          { x: 62, y: 253 },
          { x: 415, y: 255 },
          { x: 574, y: 287 },
          { x: 95, y: 317 },
          { x: 510, y: 318 },
          { x: 5, y: 343 },
          { x: 257, y: 345 },
          { x: 633, y: 343 },
        ];
        glows.forEach( (g,i) => {
          console.log( g );
          var lantern = Unicorn.AddOverlay( "lantern" + i, "glow", g.x * 3, g.y * 3 );
          lantern.anchor.set( 0.5 );
          lantern.scale.x = 3;
          lantern.scale.y = 3;
          setInterval( () => {
            lantern.alpha = Math.random() < 0.1 ? 0 : 1;
            setTimeout( () => {
              lantern.alpha = 1;
            }, 200 + Math.random() * 200 );
          }, 500 + Math.random() * 500 );
        });
        Unicorn.Load( "walls", "web/assets/walls.png" );
        var walls = Unicorn.AddOverlay( "walls", "walls", 0, 0 );
        walls.scale.x = 3;
        walls.scale.y = 3;
        Unicorn.Load( "guide", "web/assets/numbers.png" );
        var guide = Unicorn.AddOverlay( "guide", "guide", 0, 0 );
        guide.scale.x = 3;
        guide.scale.y = 3;
        //
        // // Wall Debug
        // for( var y = 0; y < 23; y++ ) {
        //   for( var x = 0; x < 41; x++ ) {
        //     if( maze[ y * 41 + x ] === 1 ) {
        //       Unicorn.AddObject( "b", {
        //         type: "circle",
        //         x: x * 48, y: y * 48,
        //         radius: 6,
        //         isStatic: true
        //       } );
        //     }
        //   }
        // }

        addPlayer( "FANCY SHEEP", 0, 0 );
      }

      function Update( timestamp, timeDiffInMs ) {
        // Add Update Loop
        // console.log( timestamp, timeDiffInMs );

        for( var player in players ) {
          var p = players[ player ];
          if( p.path.length > 0 ) {
            // console.log( p.path );
            p.progress += timeDiffInMs / 1000 * playerSpeed;
            if( p.progress > 1 ) {
              p.progress = 0;
              p.x = p.path[ 0 ].x;
              p.y = p.path[ 0 ].y;
              Unicorn.SetPosition( p.sprite.label, gridToMap( p.x ), gridToMap( p.y ) );
              // Remove two top paths
              p.path.shift();
              p.path.shift();
            }
            else {
              var nextStop = p.path[ 0 ];
              var posX = gridToMap( p.x ) + p.progress * ( gridToMap( nextStop.x - p.x ) - 48 );
              var posY = gridToMap( p.y ) + p.progress * ( gridToMap( nextStop.y - p.y ) - 48 );
              // console.log( posX, posY );
              Unicorn.SetPosition( p.sprite.label, posX, posY );
            }
          }
        }
      }

      function addPlayer( name, x, y ) {
        if( x >= 0 && y >= 0 && x < 20 && y < 11 ) {
          // plotMap( x, y );
          pathBalls.forEach( x => {
            Unicorn.RemoveObject( x.label );
          });
          pathBalls = [];

          var path = findTheWay( maze, 41, 23,
            roomToGrid( 10 ), roomToGrid( 5 ),
            roomToGrid( x ), roomToGrid( y ) );
          // console.log( path );

          players[ name ] = {
            name: name,
            x: roomToGrid( 10 ), y: roomToGrid( 5 ),
            progress: 1,
            path,
            points: 0,
            sprite: Unicorn.AddObject( "ball" + counter++, {
                type: "circle",
                x: -1000, y: -1000,
                radius: 24,
                isStatic: true
              } )
          };

          // path.forEach( (p, i) => {
          //   if( i % 2 === 0 ) {
          //     var ball = Unicorn.AddObject( "ball" + counter++, {
          //       type: "circle",
          //       x: gridToMap( p.x ), y: gridToMap( p.y ),
          //       radius: 24,
          //       isStatic: true
          //     } );
          //     pathBalls.push( ball );
          //   }
          // });
        }
      }

      function OnChatCommand( user, command, message, flags ) {
        // Handle Chat Commands
        if( command === "maze" ) {
          var parts = message.split( " " );
          var x = parseInt( parts[ 0 ] );
          var y = parseInt( parts[ 1 ] );
          addPlayer( user, x, y );
        }
      }

      function OnChatMessage( user, message, flags, self ) {
        // Handle Chat Messages
        console.log( message );
      }

      window.addEventListener('load', () => {
        Unicorn.Create( "unicorn-display", {
          width: 1920,
          height: 1080,
          // background: "#777777",// "transparent",
          background: "transparent",
          init: Init,
          update: Update,
          channel: "Instafluff",//"MaayaInsane",
          onCommand: OnChatCommand,
          onChat: OnChatMessage,
          gravity: { x: 0, y: 0 }
        });
      });
    </script>
  </body>
</html>
