<html>
  <head>
    <title>Pink Fluffy Unicorn Game Engine</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135113520-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-135113520-1');
    </script>
    <link rel='stylesheet' href='unicorn.css' />
    <script src="pinkfluffyunicorn.min.js"></script>
    <script src="maze.js"></script>
    <script language="javascript" src="lz-string.min.js"></script>
  </head>
  <body>
    <div id="unicorn-display"></div>
    <script>
      const params = new URLSearchParams(location.search);
      window.WebFontConfig = {
          google: {
              families: ['VT323'],
          },
          active() {
              CreateGame();
          },
      };

      /* eslint-disable */
      // include the web-font loader script
      (function() {
          const wf = document.createElement('script');
          wf.src = `${document.location.protocol === 'https:' ? 'https' : 'http'
          }://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`;
          wf.type = 'text/javascript';
          wf.async = 'true';
          const s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(wf, s);
      }());
      /* eslint-enabled */

      function Update( timestamp, timeDiffInMs ) {
        // Add Update Loop
        // console.log( timestamp, timeDiffInMs );

        for( var player in players ) {
          var p = players[ player ];
          var isBaba = ( player === tagPlayer );
          var isGhost = ( player === ghostName );
          var prevX = p.sprite.position.x, prevY = p.sprite.position.y;
          if( p.path.length > 0 ) {
            // console.log( p.path );
            p.progress += timeDiffInMs / 1000 * ( isGhost ? ghostSpeed : isBaba ? tagSpeed : playerSpeed );
            if( p.progress >= 1 ) {
              p.progress = 0;
              p.x = p.path[ 0 ].x;
              p.y = p.path[ 0 ].y;
              var rX = gridToRoom( p.x );
              var rY = gridToRoom( p.y );
              if( isGameEnded ) {
              }
              if( isGhost ) {
              }
              else if( isBaba ) {
              }
              else {
                // Check for prizes
                for( var i = 0; i < prizes.length; i++ ) {
                  if( prizes[ i ].x === rX && prizes[ i ].y === rY ) {
                    p.points += prizeValues[ prizes[ i ].type ];
                    console.log( p.name + " GOT THE PRIZE AND NOW HAS " + p.points + " points!" );
                    Unicorn.RemoveObject( prizes[ i ].sprite.label );
                    prizes.splice( i, 1 );
                    addPrize();
                    showLeaderboard();
                  }
                }
                for( var i = 0; i < traps.length; i++ ) {
                  if( traps[ i ].x === rX && traps[ i ].y === rY ) {
                    p.points += prizeValues[ traps[ i ].type ];
                    console.log( p.name + " HIT A TRAP AND NOW HAS " + p.points + " points!" );
                    Unicorn.RemoveObject( traps[ i ].sprite.label );
                    traps.splice( i, 1 );
                    addTrap();
                    showLeaderboard();
                  }
                }
              }
              Unicorn.SetPosition( p.sprite.label, gridToMap( p.x ), gridToMap( p.y ) );
              // Remove two top paths
              p.path.shift();
              p.path.shift();
            }
            else {
              var nextStop = p.path[ 0 ];
              var posX = gridToMap( p.x ) + p.progress * ( gridToMap( nextStop.x - p.x ) - 48 );
              var posY = gridToMap( p.y ) + p.progress * ( gridToMap( nextStop.y - p.y ) - 48 );
              // console.log( posX, posY );
              Unicorn.SetPosition( p.sprite.label, posX, posY );
              var rX = gridToRoom( mapToGrid( posX ) + 1 );
              var rY = gridToRoom( mapToGrid( posY ) + 1 );
              // console.log( posX, posY, rX, rY );
              if( !isGhost && fog[ rY * 20 + rX ].alpha > 0 ) {
                fog[ rY * 20 + rX ].alpha = Math.min( 1.0 - p.progress, fog[ rY * 20 + rX ].alpha );
              }
            }
          }
          else {
            if( isGhost ) {
              moveGhost();
            }
          }
          // Check for Ghost!
          if( !isGameEnded && isGhost ) {
            // See if Ghost is touching any other player
            for( var other in players ) {
              var o = players[ other ];
              if( other !== player ) {
                if( o.x === p.x && o.y === p.y ) {
                  if( o.x !== prevGhostX && o.y !== prevGhostY ) {
                    prevGhostX = o.x; prevGhostY = o.y;
                    if( players[ other ].points > 0 ) {
                      var pointsStolen = Math.ceil( ( 0.1 + 0.4 * Math.random() ) * players[ other ].points );
                      players[ other ].points -= pointsStolen;
                      players[ player ].points += pointsStolen;
                    }
                    console.log( "BOO!", other );
                  }
                }
              }
            }
          }
          // Check for BABA!
          if( !isGameEnded && isBaba ) {
            // See if BABA is touching any other player
            for( var other in players ) {
              var o = players[ other ];
              if( other !== player ) {
                if( o.x === p.x && o.y === p.y ) {
                  if( o.x !== prevTagX && o.y !== prevTagY ) {
                    prevTagX = o.x; prevTagY = o.y;
                    tagPlayer = other;
                    console.log( "TAG!", tagPlayer );
                  }
                }
              }
            }
          }
          p.label.x = p.sprite.position.x;
          if( p.label.x < 50 ) {
             p.label.x += 50;
          }
          p.label.y = p.sprite.position.y - 60;
          if( p.label.y < 60 ) {
             p.label.y += 60;
          }
          p.label.anchor.set( 0.5 );
          if( isBaba ) {
            // console.log( tagStar );
            tagStar.x = p.sprite.position.x;
            tagStar.y = p.sprite.position.y - 30;
          }

          p.scoreLabel.x = p.label.x;
          p.scoreLabel.y = p.label.y - 30;
          p.scoreLabel.text = p.points === 0 ? "" : p.points;
          p.scoreLabel.anchor.set( 0.5 );

          var direction = "front";
          if( p.sprite.position.x < prevX ) {
            direction = "left";
          }
          else if( p.sprite.position.x > prevX ) {
            direction = "right";
          }
          else if( p.sprite.position.y < prevY ) {
            direction = "back";
          }
          p.direction = direction;
          p.frameTime += timeDiffInMs;
          if( p.frameTime > 1000 / 10 ) {
            p.frameTime = 0;
            if( p.character === "ghost" ) {
              p.frame = ( p.frame + 1 ) % 18;
              // console.log( player, p.frame );
              var frameName = characters[ p.character ] + p.frame;
              // console.log( p.sprite );
              // console.log( assetReference[ frameName ] );
              p.sprite.sprite.texture = assetReference[ frameName ];
            }
            else {
              p.frame = ( p.frame + 1 ) % 10;
              // console.log( player, p.frame );
              var frameName = characters[ p.character ] + "_" + direction + p.frame;
              // console.log( p.sprite );
              // console.log( assetReference[ frameName ] );
              p.sprite.sprite.texture = assetReference[ frameName ];
            }
          }
        }

      }


    </script>
  </body>
</html>
